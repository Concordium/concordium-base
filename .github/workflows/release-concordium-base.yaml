name: Relase Concordium Base

on:

  workflow_dispatch: 
  
  push:
    tags:
      - releases/concordium-base/*
  

env:
  TAG: ${{ github.ref_name }}

jobs:
  concordium-base-release:
    name: concordium-base:release
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: rust-src/concordium_base

    environment: release

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: validate tag version has correct matching tag
      run: |
        echo "Validating tag version $TAG matches expected version from Cargo.toml"
        EXPECTED_VERSION_FROM_CARGO=$(yq .package.version ./Cargo.toml)
        TAG_VERSION_NUMBER=${TAG##releases/concordium-base/}

        # Check if the tag version number matches the expected version from Cargo.toml
        if [ "$TAG_VERSION_NUMBER" != "$EXPECTED_VERSION_FROM_CARGO" ]; then
          echo "version tagged: $TAG_VERSION_NUMBER  does not match cargo version: $EXPECTED_VERSION_FROM_CARGO. Exiting."
          exit 1
        else
          echo "Tag version number matches expected version from Cargo.toml. Proceeding with release."
        fi

    - name: Publish to crates.io
      env:
        CARGO_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: |
        echo "Publishing Concordium Base to crates.io for version: $TAG_VERSION"
        cargo publish --token $CARGO_TOKEN --locked
  