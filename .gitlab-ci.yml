image: 192549843005.dkr.ecr.eu-west-1.amazonaws.com/concordium/base-haskell:0.1

stages:
  - lint
  - test

.generic:
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    LD_LIBRARY_PATH: "${CI_PROJECT_DIR}/crypto/rust-src/target/release:$LD_LIBRARY_PATH"
  before_script:
    - rustc --version && cargo --version
    - git config --global url.https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/.insteadOf ssh://git@gitlab.com:22/

.generic-lint:
  extends: .generic

.generic-test:
  extends: .generic

"lint:fmt":
  extends: .generic-lint
  stage: lint
  image: 192549843005.dkr.ecr.eu-west-1.amazonaws.com/concordium/base-rust-fmt:2019-11-13
  script:
    - ( cd rust-src && cargo fmt -- --color=always)
    - test $(git ls-files --modified | grep -v ".dll$" | grep -v ".a$" | grep -v ".pc$" | grep -v ".def$" | wc -l) -eq 0 || (echo 'You have introduced some unformatted code:'; git ls-files --modified | grep -v ".dll$" | grep -v ".a$" | grep -v ".pc$" | grep -v ".def$" | sed 's/^/* /'; echo 'Please run `cargo fmt` and amend your MR.'; exit 1)

"lint:clippy":
  extends: .generic-lint
  stage: lint
  script:
    - ( cd rust-src && cargo clippy --color=always --all )

"stack:test":
  extends: .generic-test
  stage: test
  cache:
    paths:
      - .stack
      - .stack-work
      - target
  script: 
    - stack exec -- ghc --print-libdir
    - ( cd rust-src && cargo build --release )
    - stack test

"cargo:test":
  extends: .generic-test
  stage: test
  script:
    - ( cd rust-src && cargo test --all --verbose --color=always)