image: 192549843005.dkr.ecr.eu-west-1.amazonaws.com/concordium/base-haskell:0.14

stages:
  - lint
  - test

.generic:
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    LD_LIBRARY_PATH: "${CI_PROJECT_DIR}/rust-src/target/release:$LD_LIBRARY_PATH"
    STACK_ROOT: "${CI_PROJECT_DIR}/.stack"
    RUSTFLAGS: -Dwarnings
  before_script:
    - rustc --version && cargo --version
    - git config --global url.https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/.insteadOf ssh://git@gitlab.com:22/
  cache:
    paths:
      - .stack
      - .stack-work
      - target

.generic-lint:
  extends: .generic

.generic-test:
  extends: .generic

"lint:fmt":
  extends: .generic-lint
  stage: lint
  image: 192549843005.dkr.ecr.eu-west-1.amazonaws.com/concordium/base-rust-fmt:2019-11-13
  cache: {}
  script:
    - ( cd rust-src && cargo fmt -- --color=always)
    - ( cd rust-bins && cargo fmt -- --color=always)
    - ( cd idiss && cargo fmt -- --color=always)
    - ( cd mobile_wallet && cargo fmt -- --color=always)
    - ( cd identity-provider-service && cargo fmt -- --color=always)
    - test $(git ls-files --modified | grep -v ".dll$" | grep -v ".a$" | grep -v ".pc$" | grep -v ".def$" | wc -l) -eq 0 || (echo 'You have introduced some unformatted code:'; git ls-files --modified | grep -v ".dll$" | grep -v ".a$" | grep -v ".pc$" | grep -v ".def$" | sed 's/^/* /'; echo 'Please run `cargo fmt` and amend your MR.'; exit 1)

"lint:clippy":
  extends: .generic-lint
  stage: lint
  cache: {}
  script:
    - ( cd rust-src && cargo clippy --color=always --all )
    - ( cd rust-bins && cargo clippy --features=vendored-ssl --color=always --all )
    - ( cd identity-provider-service && cargo clippy --features=vendored-ssl --color=always --all )
    - ( cd idiss && cargo clippy --color=always --all )

"cargo:build-bench":
  extends: .generic-lint
  stage: test
  cache: {}
  script:
    - ( cd rust-src && cargo bench --color=always --no-run)

"stack:test":
  extends: .generic-test
  stage: test
  script:
    - ( cd rust-src && cargo build --release)
    - stack test

"cargo:test":
  extends: .generic-test
  stage: test
  cache: {}
  script:
    - ( cd rust-src && cargo test --all --verbose --release --color=always)

"cargo:test-id-service":
  extends: .generic-test
  stage: test
  cache: {}
  script:
    - ( cd identity-provider-service && cargo test --features=vendored-ssl --all --verbose --release --color=always)
